#!/bin/sh -e

#####################################################################
#                                                                   #
#               Backend server install script:                      #
#                                                                   #
# Publishing vendor files                                           #
# Generating application key hash                                   #
# Generating Subscribo Common Secret hash                           #
# Building autogenerated files                                      #
# Running migrations (creating DB tables)                           #
# Seeding database                                                  #
# Running regular maintenance for the first time                    #
# Setting up crontab for regular jobs                               #
# Setting up queue listener                                         #
# Optionally (if argument "test" was specified) running unit test   #
#                                                                   #
#####################################################################

set -x

CURRENT_DIR=`pwd -P`

cd `dirname "$BASH_SOURCE"`/..

PROJECT_DIR=`pwd -P`

php artisan vendor:publish --force

if [ ! -f .env ]; then
    cp .env.example .env
fi

if [ ! -f .env.frontend ]; then
    php artisan key:generate
    cp .env .env.frontend
fi

php artisan key:generate
php artisan subscribo-common-secret:generate
php artisan build
php artisan migrate:refresh --seed
php artisan maintain:hourly
echo "* * * * * php $PROJECT_DIR/artisan schedule:run >> /dev/null 2>&1" | crontab -
php artisan queue:listen > /dev/null 2>&1  &

if [ "$1" = "test" ]; then
    phpunit
fi

cd "$CURRENT_DIR"

if [ "$0" = "-bash" ]; then
    set +x
fi
